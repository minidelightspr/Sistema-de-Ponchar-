<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Payroll - Mini Delights</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<style>
body {
  font-family: Arial, sans-serif;
  background: #f4f6f8;
  padding: 20px;
}
h2 {
  text-align: center;
}
table {
  width: 100%;
  border-collapse: collapse;
  background: white;
  margin-top: 20px;
}
th, td {
  padding: 10px;
  border-bottom: 1px solid #ddd;
  text-align: left;
}
th {
  background: #0d6efd;
  color: white;
}
</style>
</head>

<body>

<h2>ðŸ“Š Payroll Semanal</h2>

<table id="tabla">
  <thead>
    <tr>
      <th>Empleado</th>
      <th>Horas</th>
      <th>Bruto</th>
      <th>Deducciones</th>
      <th>Neto</th>
      <th>Vacaciones</th>
      <th>Enfermedad</th>
      <th>Bono</th>
      <th>YTD</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
const { createClient } = supabase;

/* ===== SUPABASE (YA CONFIGURADO) ===== */
const supabaseClient = createClient(
  "https://chwrkastzilaixqmjsbu.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNod3JrYXN0emlsYWl4cW1qc2J1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc0MzcwOTYsImV4cCI6MjA4MzAxMzA5Nn0.QRimlOzaID5Ldr1CojiZYtqMzAKp2vm93QtzPxLEZ4I"
);

/* ===== CAMBIA SOLO LAS FECHAS SI QUIERES ===== */
const fechaInicio = "2026-01-01";
const fechaFin = "2026-01-07";

async function cargar() {
  const { data, error } = await supabaseClient
    .from("payroll_final")
    .select(`
      employee_name,
      hours_worked,
      gross_pay,
      total_deductions,
      net_pay,
      employee_balances (
        vacation_hours,
        sick_hours,
        hours_ytd,
        pay_ytd
      ),
      employee_bonus (
        bonus_accrued
      )
    `)
    .gte("punch_date", fechaInicio)
    .lte("punch_date", fechaFin);

  if (error) {
    alert(error.message);
    return;
  }

  const tabla = document.querySelector("#tabla tbody");
  tabla.innerHTML = "";

  const resumen = {};

  data.forEach(r => {
    if (!resumen[r.employee_name]) {
      resumen[r.employee_name] = {
        horas: 0,
        bruto: 0,
        ded: 0,
        neto: 0,
        vac: r.employee_balances?.vacation_hours || 0,
        sick: r.employee_balances?.sick_hours || 0,
        bono: r.employee_bonus?.bonus_accrued || 0,
        ytd: r.employee_balances?.pay_ytd || 0
      };
    }

    resumen[r.employee_name].horas += r.hours_worked;
    resumen[r.employee_name].bruto += r.gross_pay;
    resumen[r.employee_name].ded += r.total_deductions;
    resumen[r.employee_name].neto += r.net_pay;
  });

  Object.keys(resumen).forEach(nombre => {
    const r = resumen[nombre];
    tabla.innerHTML += `
      <tr>
        <td>${nombre}</td>
        <td>${r.horas.toFixed(2)}</td>
        <td>$${r.bruto.toFixed(2)}</td>
        <td>$${r.ded.toFixed(2)}</td>
        <td>$${r.neto.toFixed(2)}</td>
        <td>${r.vac.toFixed(2)}</td>
        <td>${r.sick.toFixed(2)}</td>
        <td>$${r.bono.toFixed(2)}</td>
        <td>$${r.ytd.toFixed(2)}</td>
      </tr>
    `;
  });
}

cargar();
</script>

</body>
</html>
