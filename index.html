<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Sistema de Ponche QR - Mini Delights</title>

<script src="https://unpkg.com/html5-qrcode"></script>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<style>
body {
  font-family: Arial, sans-serif;
  background: #f4f6f8;
  text-align: center;
  padding: 20px;
}
h2 {
  margin-bottom: 5px;
}
#reader {
  width: 320px;
  margin: 20px auto;
}
button {
  padding: 12px 20px;
  font-size: 16px;
  background: #0d6efd;
  color: white;
  border: none;
  border-radius: 6px;
}
#msg {
  margin-top: 15px;
  font-weight: bold;
  font-size: 18px;
}
</style>
</head>

<body>

<h2>üì∏ Sistema de Ponche</h2>
<p>Entrada ‚Ä¢ Almuerzo ‚Ä¢ Salida</p>

<button onclick="startScanner()">Abrir C√°mara</button>

<div id="reader"></div>
<div id="msg"></div>

<script>
/* üîë CONEXI√ìN A TU SUPABASE */
const supabase = supabaseJs.createClient(
  "https://chwrkastzilaixqmjsbu.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNod3JrYXN0emlsYWl4cW1qc2J1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc0MzcwOTYsImV4cCI6MjA4MzAxMzA5Nn0.QRimlOzaID5Ldr1CojiZYtqMzAKp2vm93QtzPxLEZ4I"
);

let scanner = null;

async function onScanSuccess(qrText) {
  document.getElementById("msg").innerText = "‚è≥ Procesando...";

  const qr = qrText.trim();

  const { data: employee } = await supabase
    .from("employees")
    .select("*")
    .ilike("qr_code", qr)
    .eq("active", true)
    .single();

  if (!employee) {
    document.getElementById("msg").innerText = "‚ùå EMPLEADO NO REGISTRADO";
    return;
  }

  const today = new Date().toISOString().slice(0, 10);

  const { data: punches } = await supabase
    .from("punches")
    .select("*")
    .eq("employee_id", employee.id)
    .eq("punch_date", today)
    .order("created_at");

  let type = "";

  if (!punches || punches.length === 0) {
    type = "entrada";
  } else if (punches.length === 1) {
    type = "almuerzo_salida";
  } else if (punches.length === 2) {
    type = "almuerzo_entrada";
  } else if (punches.length === 3) {
    type = "salida";
  } else {
    document.getElementById("msg").innerText =
      "‚ö†Ô∏è Ya complet√≥ todos los ponches hoy";
    return;
  }

  await supabase.from("punches").insert({
    employee_id: employee.id,
    punch_type: type
  });

  const labels = {
    entrada: "ENTRADA",
    almuerzo_salida: "SALIDA A ALMUERZO",
    almuerzo_entrada: "REGRESO DE ALMUERZO",
    salida: "SALIDA"
  };

  document.getElementById("msg").innerText =
    `‚úÖ ${employee.name} ‚Äì ${labels[type]}`;
}

function startScanner() {
  if (scanner) return;
  scanner = new Html5Qrcode("reader");
  scanner.start(
    { facingMode: "environment" },
    { fps: 10, qrbox: 250 },
    onScanSuccess
  );
}
</script>

</body>
</html>
